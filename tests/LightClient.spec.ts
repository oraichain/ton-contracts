import { Blockchain, printTransactionFees, SandboxContract, TreasuryContract } from '@ton/sandbox';
import { Cell, toNano } from '@ton/core';
import { LightClient, Opcodes } from '../wrappers/LightClient';
import '@ton/test-utils';
import { compile } from '@ton/blueprint';
import blockData from './fixtures/data.json';
import newBlockData from './fixtures/new_data.json';
import newNewBlockData from './fixtures/new_data_1.json';

describe('LightClient', () => {
    let code: Cell;
    beforeAll(async () => {
        // code = await compile('LightClient');
        code = Cell.fromBoc(
            Buffer.from(
                'b5ee9c7241029501001252000114ff00f4a413f4bcf2c80b01020162028c0202c9037a020120044c0201200522020120061b0201200714020120081104cd46c2220c700915be001d0d3030171b0915be0f058fa403001d31fd33f2282108c6ff376ba8fb76c12d430d0d401d0db3cf84324bcf2d19603f863f84422f050c3fff2d19801f864f86570f861f84621f050c3ff925f04e30d70f862db3ce02282105415ab73ba8090a0e0b0032d401d0d431d401d001d31f3002d430d0d431d401d001d430d001ac71f861f866d421c8cc02d06d709522c702c3ff8e1702d401d001d430d0d39f66048100a0f41602d31f3013a0e83203cbff12ccc9f868d430c8c85004cf16ccc982105415ab735003cb1fcb3fccc970f828588040db3c10049c8f3932810c1ff82814f050c3ff13f2f2f846f848d0f046c3fff2d194d430c882107bae3b0001cb1f12cb3fccc970f828588040db3c800bf862db3ce02282107bae3b00bae3020282109c8be18eba100e0c0f02826c31f841c00099810fa1f842c30bf2f2ded430d0fa40d430d0f841f843f844f847d0f848d0104510341023f048c3fff2d193f848f86770f86270018040db3cdb3c0d0e0028708018c8cb055003cf165003fa02cb6ac901fb000064c8f846cf16c9c8f845cf16c9c8f844cf16c9f843c8cb1fccccccc9f848f847c8ccccc9f842f841c8cb00cb0712ccccc9ed5401bc8ed501d430d0d33fd401d001d401d001d401d001d430d0f84315bdf2d19602f02030206f886f84f9040070c8cb07cbffc9d0f90258f03bf845d3ff3001bdf2d1958210061827a3c8cb1f12cb3f01cf16c970598040db3ce05f03840ff2f010002c718018c8cb055004cf165004fa0212cb6accc901fb00020120121300411c086107ec083040260c086107ac20c7a83788a107ef254c59a86ac7e44cb88060003b32007232c7f274254831c030ffe6c81e35c884b3c5805e35c8fa0c32742002012015180201201617001f3c00b2007c00f3c5807c00f3c5b2742000053c0120020120191a003732007232c7f274254831c030ffe6c81e35c884b3c5805e35c8fa0c20001b3c00b2007c01b3c5c07c01b3c5e00201201c210201201d1e00054f00780201201f2000370864aa803780700026483040252103fcbc37b7a92d80e95dea41292000453200a4aa8037a50820c1afa7482101ec20c1ac5632c1c06ac1ba2101ec0072c1f274200041d64014955006f4a1041835f4e904203d8418358ac658380d583744203d800e583c0201202336020120242a02012025290201202628037d321bc000b5007400750c340871c030ffe3c4deb6cf04f3c58875d26ac0b6cf33c58073c580644c789c0871c0b000244c78c348727435d26ac0a8007274162055552702668012db3c13cf169521c702c0008e1121d749ab0213a051316f8c01d430d04303e821d749ab0213a050336f8c22db3c12cf16585555012b320871c030ffe3a21e36cf33c58073c5a44c78b2742055022d4f011c87adb3ccf1621d749ab02db3ccf1601cf16c9d0855550201202b310201202c2f04cb3500740075007400750c341c1bc00931c0b0ffe3cfcc72013c041eb6cf05f3c580b6cf04b3c58073c588327435d26ac0807274049be31c25895be214842e638454d41be04835d26ac085281408dbe300693a0c0d244d3888b1c030ffe44cb8c34831c030ffe055552d2e024802f012c88012db3ccf1621d749ab02db3ccf1601cf16c9d051336f8c03d749ab0212a001555501388e96c88018db3ccf1601cf16c9d051226f8c02d749ab02a09130e20155036532007500740831c030ffe3c54835d26ac09eb6cf0533c580f6cf04f3c59633c580644c38b50c340831c030ffe44c38c3727420555530022a20d749ab028012db3c13cf1602db3c12cf1601cf1655550201203233000d3c0575d26ac0a0049f350074007500740075007400750c3432254931c0b00023c6c135007400750c341eb6cf05b3c5897c05b6cf33c5817c054573c5ba0d08b1c030ffe3a2e00436cf0533c59633c596644cb88831c030ffe05555553403488f1620d749ab02801adb3c14cf1603db3c13cf1658cf16019130e220c700c3ff9130e30d555535022a20d749ab028022db3c13cf1602db3c12cf1601cf165555020120373c020120383900094f017c9d080201203a3b009135007400750c34322548b1c0b0002386c0b5007400750c343c054835d26ac09e940172c1c532c1d400f3c5ba0c8831c030ffe3844835d26ac0a0049400f2c1c4b2c1c073c5a44c38a000093c06b274200201203d4004a756f00709524c702c3ff8f3804d431d401d0f014c87adb3ccf1622db3ccf16c9d051446f8c04d749ab0212a016a07096266f885210b99953606f81146f8c03a4e8303504e83422c700c3ff9132e30d20c700c3ff855553e3f0254c803f0188012db3c14cf1623d749ab02db3ccf16c9d020d749ab0224d749ab02a015a0046f8c586f8c015555025e8f2ac801f01b801adb3c12cf1621d749ab02db3ccf16c9d020d749ab0222d749ab02a014a050236f8c016f8c9130e25555020120414804f7350074007500740075007400750c341bc01c254971c0b00023d08175007400750c34321eb6cf33c5807c0408b6cf0533c5b2740835d26ac086a814165be314011be31c089be224972e6694cc5be044dbe30069163a0408d7c0d418a83a0d723232321b4a31c030ffe44e38c340f27400b27400727400f27408b1c0205555424503583007d401d05301c700c3ff8f1202d33f308018db3c1acf1609db3c19cf16089132e220c700c3ff9130e30d075543440070f002c89321c2008e15228407b08306b101cb077722b113adaa1801ab0658e83194218407bc9e218407b08306b101cb0701ab0601e831c9d001f68012db3c15cf1624d749ab02ab0070935301b98e2e06d30721ab0320aa0313a122c2099302a6379302a630e222c2099302a6379302a630e25027cb0716cb0706a41056e85b9524c700c3ff8e2c04d30721ab0320aa0313a122c2099302a6379302a630e222c2099302a6379302a630e25024cb0713cb074014e8345503a6c3ff8eb821d74924d749a0ab02db3c51536f8c256f8c226f8c246f8c216f8c05d749ab0219a002d74901d749a002d74912a006d74916a0ab0215a004925f04e29522c702c3ff8ae8329520c702c3ff8ae83001554647028c02d401d001d430d0c8811ffadb3ccf1601f01022db3c14cf16c9d020d749ab0219a050686f8c50056f8c70226f88925cb99a53316f81136f8c01a458e810235f035053a0441455550288d401d001d430d0c8813ffadb3ccf1601f01022db3c14cf16c9d020d749ab0218a050576f8c50046f8c70226f88925cb99a53316f81136f8c01a458e810235f035042a003555504551bc0320135007400750c340875d26ac08875d26ac09eb6cf0633c58076cf33c59633c5a004b6cf33c581605555554904a0db3c15cf165004cf16801adb3ccf16706f009524c702c3ff8e1024d749ab0212a051146f8c04d430d004e834db3ccf16c9d0136f8c7096226f885210b99953206f81126f8c01a4e830319521c702c3ff5555554a01628ae831c8c9216f88a59320c2ff8e1e53206f8122d765c0009932c8c9c8cc58cf16c99702c8cc58cf16c9e201a5e83031d04b024001d401d001d430d0c8802adb3ccf1621f016db3ccf1601f015cf16c9d0126f8c55550201204d620201204e590201204f58020120505604f346f0001d401d001d401d001d430d002d401d001d401d001d430d003d401d001d4d4d4306f009524c702c0008ae834c8c9246f88a59320c2ff8e1c53506f8122d765c0009832c8c9c8cc12ccc99602c8cc12ccc9e201a5e8303403c8cc12ccccccc9d0f01ec87adb3ccf1603db3c13cf16c9d0176f8c70276f8885155555200cac805d401d001d430d0d401d0208d090bd8dbdcdb5dd85cdb4b9dd85cdb4b9d8c4b935cd9d15e1958dd5d1950dbdb9d1c9858dd20c705c0ff8e2501d430d0d401d001d401d001d430d0f01fc858cf16c95007ccc85007cf16c95006ccc96f8c945b35f203e204788a9a53816f81136f8c01a458e85b3603f01dc88012db3ccf1602db3c12cf16c9d0146f8c236f8870935301b99953506f81136f8c02a4e85b33c8801a5355555400045cb90250db3ccf168040db3ccf169522c702c0009e02d401d001d430d0d430d013cf16e86c12c9d0126f8c01555500087001f00b012b520c10194840ff2f0de20db3ca5ae5202ba92ab00de8570008b603a5a40025f378049a990dccc2eb7c0b7c6015201743618c0201205a5b002dd016401eb8c2819e78b10e78b00eba4896b90e78b64e840201205c5f0201205d5e00713208f0c02720081e9632c1f2c1c4f2ffc0a44cf88870c02387200820049e08600901f2c1c5b2c1c572c1c4b2c1c4f2c1c4b2c1f2ffe456f8a0001734fff4fff4c1cc3c0b3274200201206061001334fff4fff4c1cc3c0b20006d1c0871c030ffe3848074c7c870c025cc9c007c02a900644c7880778871c030ffe3844074c7cc0830c0259c007c02a928244c38a44c78a0020120637102012064690201206568020120666700e5320871c030ffe38bc074c7c870c02388de1400f2c1dc08bc029c1400fc02dc24d4c0ee664074c1c0f2c1c06904ba0408d7c0c0644c7880778871c030ffe38b8074c7cc0830c02388a0041632c1dc08bc029c1400fc02dc24d4c0ee664074c1c0f2c1c06904ba0408d7c0e44c38a44c78b274200081320871c030ffe385c074c7c870c0271e1400f2c1dc163c0333c5c0644c7880778871c030ffe3858074c7cc0830c026e0041632c1dc163c0333c5e44c38a44c78a00025520d749ab027001f00bc801cf1601cf16c9d080201206a6d0201206b6c00210833cc6ac09c007c03320073c5c073c5e001f53209b0c0261e0072c1c5b2c1c1644db889308027a0045401b2c1c13c014533c58100e44d3888b08027a006540172c1c0bc0144b3c5940ce44cb88831c030ffe3a4c836cf2008940172c1c532c1c0fc0b44f3c580a44c38883c0be00a940132c1c4f2c1c0bc0c04b3c58875d26ac0a00c9632c1f2c1c073c5b274206f0201206e7001a7320930c0261e0072c1c532c1c0e44d3888b080276004540132c1c0bc0204b3c5d6644cb88830802760065400f2c1c0bc0204b3c5c0644c388831c030ffe3a44836cf20089400f2c1c4b2c1c07c0bb3c5e44c38a06f002a7001d3ffd3ff3001c30093802232dec30092a626de0041087c0be00a940132c1c4f2c1c07c0c73c5c875d26ac0a00c9632c1f2c1c073c5a0020120727902012073770201207475015f081be20830002496dc38083000678c1c3232c1c05bc433c5b2743e40b8083c08c89c08bc09fc0e10c4fc09fc0e36cf207802530830002496dc3808300063a18c34ffcc36cf38083c08d4c83c0e486540f50c3400f9166844bc0e76cf207678001470c8cb07cbffc9d0f902025559522c702c0008f1f02d401d001d430d0d3ff3003d30001c0008e845023db3c8e845adb3c12e258e8303187878001a71c8cb0712cbffcbffc9d0f90200e96720871c030ffe38c0074c7c870c023891e1400f2c1dc08bc02dc1400fc029c24d4c06e6680f4c1c0f2c1c0e90408fa0408d7c0c0644c7880778871c030ffe38bc074c7cc0830c02388e0041632c1dc08bc02dc1400fc029c24d4c06e6680f4c1c0f2c1c0e90408fa0408d7c0e44c38a44c78b27420201487b890201207c850201207d800201207e7f001f420c700c0ff923071e0d749ab02a6028001d420d749ab027ac8cb07cb0701cf16802012081840201208283005b320060402835c8750074083c10807c101e940132c1c4f2c1d633c5c074c7cc1c007c0320041632c1c073c5f27420002b34c7f4c7f4c7f500740075007400750c343c0d7c0ce0004946f0001d430d09520c702c3ff9dd401d001d430d0f044126f8c01e83001d3ff3001f038ba801cbdf6d176fd81698fa90b5ec9af83387002698fea00e800ea1868380269ff80d50039d48200ea18ea181283e9ff80d50039d48200ea18ea1829b8e00049af86b8703fe4114a94638161ffc74a846a00e800ea1868106ba4c081545f489871868452742f87983848602fad307d39f8308d718d430d023c00224c00305c00101810bb906a001a0c00014f2f224cf31c000993472561153edf03604de52435611f037f034c9d02ac3008e2d3553088100a0f40e6fa1c0ff8e18d401d0d3ff30546640f9119906a406d31f301ea00d9130e29130e253d9bc05de5612925f03e30d53c5bc5230b0e3028788004851178100a0f40e6fa1c0ff8e13d401d0d3ff3013f91196d31f301da00c9130e2925f03e2000c5f0f307fdb310201208a8b000fd80fc8080fc80dd40061df6a268698000fc30e98380fc316a00e8698f80fc31ea00e87c326a00e87c32ea18687c336a00e86a00fc33ea187c3468c0201208d900201208e8f000db9b82f058f8458000dba704f058f84380201209192000dba829f058f84680201209394001bb4e3de0406040df10df09f208010000db4091e0b1f08909798ac42',
                'hex',
            ),
        )[0];
    });

    let blockchain: Blockchain;
    let deployer: SandboxContract<TreasuryContract>;
    let lightClient: SandboxContract<LightClient>;

    beforeEach(async () => {
        blockchain = await Blockchain.create();
        blockchain.verbosity = {
            ...blockchain.verbosity,
            // vmLogs: 'vm_logs_gas',
        };
        lightClient = blockchain.openContract(
            LightClient.createFromConfig(
                {
                    chainId: 'Oraichain',
                    height: 1,
                    validatorHashSet: '',
                    dataHash: '',
                    nextValidatorHashSet: '',
                },
                code,
            ),
        );

        deployer = await blockchain.treasury('deployer');

        const deployResult = await lightClient.sendDeploy(deployer.getSender(), toNano('0.05'));

        expect(deployResult.transactions).toHaveTransaction({
            from: deployer.address,
            to: lightClient.address,
            deploy: true,
            success: true,
        });
    });

    it('test light client verify block hash', async () => {
        const testcase = async (blockData: any) => {
            const { header, commit, validators } = blockData;
            const user = await blockchain.treasury('user');
            let result = await lightClient.sendVerifyBlockHash(
                user.getSender(),
                {
                    appHash: header.app_hash,
                    chainId: header.chain_id,
                    consensusHash: header.consensus_hash,
                    dataHash: header.data_hash,
                    evidenceHash: header.evidence_hash,
                    height: BigInt(header.height),
                    lastBlockId: header.last_block_id,
                    lastCommitHash: header.last_commit_hash,
                    lastResultsHash: header.last_results_hash,
                    validatorHash: header.validators_hash,
                    nextValidatorHash: header.next_validators_hash,
                    proposerAddress: header.proposer_address,
                    time: header.time,
                    version: header.version,
                },
                validators,
                commit,
                { value: toNano('10') },
            );

            printTransactionFees(result.transactions);

            expect(result.transactions).toHaveTransaction({
                op: Opcodes.verify_block_hash,
                success: true,
            });

            expect(result.transactions).toHaveTransaction({
                op: Opcodes.verify_sigs,
                success: true,
            });

            console.log(`blockhash:`, Opcodes.verify_block_hash);
            console.log('Finished: ', {
                height: await lightClient.getHeight(),
                chainId: await lightClient.getChainId(),
                dataHash: (await lightClient.getDataHash()).toString('hex'),
                validatorHash: (await lightClient.getValidatorHash()).toString('hex'),
            });
        };
        await testcase(blockData);
        await testcase(newBlockData);
        await testcase(newNewBlockData);
    });
});
